version: "3.9"

services:
  ovs:
    build:
      context: .
      dockerfile_inline: |
        FROM ubuntu:22.04
        RUN apt-get update && \
            apt-get install -y openvswitch-switch iproute2 iputils-ping && \
            rm -rf /var/lib/apt/lists/*

        RUN echo '#!/bin/bash\n\
        set -e\n\
        mkdir -p /var/run/openvswitch\n\
        if [ ! -f /etc/openvswitch/conf.db ]; then\n\
          ovsdb-tool create /etc/openvswitch/conf.db /usr/share/openvswitch/vswitch.ovsschema\n\
        fi\n\
        ovsdb-server --remote=punix:/var/run/openvswitch/db.sock \\\n\
                     --remote=db:Open_vSwitch,Open_vSwitch,manager_options \\\n\
                     --pidfile --detach\n\
        ovs-vsctl --no-wait init || true\n\
        ovs-vswitchd --pidfile --detach --log-file\n\
        sleep 2\n\
        ovs-vsctl add-br br0 -- set Bridge br0 datapath_type=netdev\n\
        echo "OVS started successfully"\n\
        ovs-vsctl show\n\
        exec sleep infinity\n\
        ' > /start-ovs.sh && chmod +x /start-ovs.sh

    container_name: ovs
    privileged: true
    network_mode: none
    command: /start-ovs.sh

  router1:
    build:
      context: .
      dockerfile_inline: |
        FROM ubuntu:22.04
        RUN apt-get update && \
            apt-get install -y iproute2 iputils-ping keepalived tcpdump && \
            rm -rf /var/lib/apt/lists/*
        
        RUN echo '#!/bin/bash\n\
        echo "Waiting for network interface..."\n\
        for i in {1..30}; do\n\
          if [ -e /sys/class/net/eth0 ]; then\n\
            echo "eth0 found!"\n\
            break\n\
          fi\n\
          sleep 1\n\
        done\n\
        if [ ! -e /sys/class/net/eth0 ]; then\n\
          echo "eth0 not found, entering sleep mode"\n\
          exec sleep infinity\n\
        fi\n\
        mkdir -p /etc/keepalived\n\
        cat > /etc/keepalived/keepalived.conf <<EOF\n\
        vrrp_instance VI_1 {\n\
            state MASTER\n\
            interface eth0\n\
            virtual_router_id 51\n\
            priority 100\n\
            advert_int 1\n\
            authentication {\n\
                auth_type PASS\n\
                auth_pass 1234\n\
            }\n\
            virtual_ipaddress {\n\
                10.0.0.254/24\n\
            }\n\
        }\n\
        EOF\n\
        ip addr add 10.0.0.1/24 dev eth0\n\
        ip link set eth0 up\n\
        sysctl -w net.ipv4.ip_forward=1\n\
        sysctl -w net.ipv4.ip_nonlocal_bind=1\n\
        echo "Router1 network configured"\n\
        ip addr show eth0\n\
        keepalived -n -l -D\n\
        ' > /start.sh && chmod +x /start.sh
        
    container_name: router1
    privileged: true
    network_mode: none
    cap_add:
      - NET_ADMIN
    command: /start.sh
    restart: "no"

  router2:
    build:
      context: .
      dockerfile_inline: |
        FROM ubuntu:22.04
        RUN apt-get update && \
            apt-get install -y iproute2 iputils-ping keepalived tcpdump && \
            rm -rf /var/lib/apt/lists/*
        
        RUN echo '#!/bin/bash\n\
        echo "Waiting for network interface..."\n\
        for i in {1..30}; do\n\
          if [ -e /sys/class/net/eth0 ]; then\n\
            echo "eth0 found!"\n\
            break\n\
          fi\n\
          sleep 1\n\
        done\n\
        if [ ! -e /sys/class/net/eth0 ]; then\n\
          echo "eth0 not found, entering sleep mode"\n\
          exec sleep infinity\n\
        fi\n\
        mkdir -p /etc/keepalived\n\
        cat > /etc/keepalived/keepalived.conf <<EOF\n\
        vrrp_instance VI_1 {\n\
            state BACKUP\n\
            interface eth0\n\
            virtual_router_id 51\n\
            priority 90\n\
            advert_int 1\n\
            authentication {\n\
                auth_type PASS\n\
                auth_pass 1234\n\
            }\n\
            virtual_ipaddress {\n\
                10.0.0.254/24\n\
            }\n\
        }\n\
        EOF\n\
        ip addr add 10.0.0.2/24 dev eth0\n\
        ip link set eth0 up\n\
        sysctl -w net.ipv4.ip_forward=1\n\
        sysctl -w net.ipv4.ip_nonlocal_bind=1\n\
        echo "Router2 network configured"\n\
        ip addr show eth0\n\
        keepalived -n -l -D\n\
        ' > /start.sh && chmod +x /start.sh
        
    container_name: router2
    privileged: true
    network_mode: none
    cap_add:
      - NET_ADMIN
    command: /start.sh
    restart: "no"

  client:
    build:
      context: .
      dockerfile_inline: |
        FROM ubuntu:22.04
        RUN apt-get update && \
            apt-get install -y iproute2 iputils-ping tcpdump curl && \
            rm -rf /var/lib/apt/lists/*
        
        RUN echo '#!/bin/bash\n\
        echo "Waiting for network interface..."\n\
        for i in {1..30}; do\n\
          if [ -e /sys/class/net/eth0 ]; then\n\
            echo "eth0 found!"\n\
            break\n\
          fi\n\
          sleep 1\n\
        done\n\
        if [ ! -e /sys/class/net/eth0 ]; then\n\
          echo "eth0 not found, entering sleep mode"\n\
          exec sleep infinity\n\
        fi\n\
        ip addr add 10.0.0.100/24 dev eth0\n\
        ip link set eth0 up\n\
        ip route add default via 10.0.0.254\n\
        echo "Client network configured"\n\
        ip addr show eth0\n\
        ip route show\n\
        exec sleep infinity\n\
        ' > /start.sh && chmod +x /start.sh

    container_name: client
    network_mode: none
    cap_add:
      - NET_ADMIN
    command: /start.sh
    restart: "no"